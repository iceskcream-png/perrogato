<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë¹¼ë¡œê°€ë˜ë„¤ ê°€ê³„ë¶€</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');

  * { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --toss: #3182f6;
    --cashback: #10b981;
    --expense: #ef4444;
    --bg: #f0f4ff;
    --card-bg: #ffffff;
    --text: #191f28;
    --subtext: #8b95a1;
    --border: #e8ecf0;
    --radius: 16px;
  }

  body {
    font-family: 'Noto Sans KR', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding-bottom: 40px;
  }

  header {
    background: #fff;
    padding: 18px 20px 14px;
    text-align: center;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  header h1 { font-size: 18px; font-weight: 700; color: var(--text); letter-spacing: -0.5px; }

  .container { max-width: 480px; margin: 0 auto; padding: 0 16px; }

  .month-selector {
    display: flex; align-items: center; justify-content: center;
    gap: 16px; padding: 20px 0 15px;
  }
  .month-btn {
    background: none; border: none; font-size: 22px; cursor: pointer;
    color: var(--subtext); padding: 4px 8px; border-radius: 8px; transition: all 0.2s;
  }
  .month-btn:hover { background: var(--border); color: var(--text); }
  .month-display { font-size: 20px; font-weight: 700; color: var(--text); min-width: 120px; text-align: center; }

  .bank-card {
    background: var(--card-bg); border-radius: var(--radius);
    padding: 20px; box-shadow: 0 2px 12px rgba(49,130,246,0.08); margin-bottom: 15px;
  }
  .bank-name {
    font-size: 15px; font-weight: 700; color: var(--text);
    margin-bottom: 15px; padding-bottom: 12px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 8px;
  }
  .toss-dot {
    width: 22px; height: 22px; background: var(--toss);
    border-radius: 6px; display: inline-block; flex-shrink: 0;
  }

  .budget-rows { display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
  .budget-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; }
  .budget-label { font-size: 13px; color: var(--subtext); }
  .budget-value { font-size: 13px; font-weight: 500; color: var(--text); }
  .budget-value.green { color: var(--cashback); font-weight: 600; }

  .remaining-box {
    padding: 14px 18px; border-radius: 12px; margin-top: 10px;
    display: flex; justify-content: space-between; align-items: center;
    background: var(--toss);
  }
  .remaining-label { font-size: 12px; font-weight: 500; color: rgba(255,255,255,0.75); }
  .remaining-amount { font-size: 24px; font-weight: 700; color: white; }

  .divider { height: 1px; background: var(--border); margin: 12px 0; }

  .category-summary { display: flex; flex-direction: column; gap: 8px; }
  .cat-row { display: flex; justify-content: space-between; align-items: center; padding: 3px 0; }
  .cat-label { font-size: 13px; color: var(--subtext); }
  .cat-value { font-size: 13px; font-weight: 500; color: var(--text); }
  .cat-value.green { color: var(--cashback); font-weight: 600; }

  .form-card {
    background: var(--card-bg); border-radius: var(--radius);
    padding: 20px; box-shadow: 0 2px 12px rgba(49,130,246,0.08); margin-bottom: 15px;
  }
  .form-title { font-size: 15px; font-weight: 700; margin-bottom: 16px; color: var(--text); }
  .form-grid { display: flex; flex-direction: column; gap: 10px; }
  .form-row { display: flex; gap: 10px; }
  .form-group { display: flex; flex-direction: column; gap: 4px; flex: 1; }
  .form-group label { font-size: 11px; color: var(--subtext); font-weight: 500; }
  .form-group select,
  .form-group input {
    padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px;
    font-size: 14px; font-family: 'Noto Sans KR', sans-serif; color: var(--text);
    background: #f8faff; outline: none; transition: border-color 0.2s; width: 100%;
  }
  .form-group select:focus,
  .form-group input:focus { border-color: var(--toss); background: white; }

  .type-selector { display: flex; gap: 8px; }
  .type-btn {
    flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 10px;
    background: #f8faff; font-size: 13px; font-weight: 500; cursor: pointer;
    transition: all 0.2s; font-family: 'Noto Sans KR', sans-serif; color: var(--subtext);
  }
  .type-btn.active.expense { background: #fef2f2; border-color: var(--expense); color: var(--expense); }
  .type-btn.active.cashback-btn { background: #f0fdf4; border-color: var(--cashback); color: var(--cashback); }

  .submit-btn {
    width: 100%; padding: 13px; border: none; border-radius: 12px;
    background: var(--toss); color: white; font-size: 14px; font-weight: 600;
    cursor: pointer; margin-top: 4px; font-family: 'Noto Sans KR', sans-serif; transition: opacity 0.2s;
  }
  .submit-btn:hover { opacity: 0.85; }

  .transactions-card {
    background: var(--card-bg); border-radius: var(--radius);
    padding: 20px; box-shadow: 0 2px 12px rgba(49,130,246,0.08);
  }
  .tx-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
  .tx-title { font-size: 15px; font-weight: 700; color: var(--text); }
  .clear-btn {
    font-size: 12px; color: var(--expense); background: none; border: none;
    cursor: pointer; font-family: 'Noto Sans KR', sans-serif;
    padding: 4px 8px; border-radius: 6px; transition: background 0.2s;
  }
  .clear-btn:hover { background: #fef2f2; }

  .tx-list { display: flex; flex-direction: column; }
  .tx-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 4px; border-bottom: 1px solid var(--border);
  }
  .tx-item:last-child { border-bottom: none; }
  .tx-left { flex: 1; min-width: 0; }
  .tx-row1 { font-size: 12px; color: var(--subtext); margin-bottom: 3px; }
  .tx-row2 { font-size: 13px; color: var(--text); display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
  .tx-memo { color: #aaa; font-size: 12px; }
  .tx-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
  .tx-amount { font-size: 14px; font-weight: 600; }
  .tx-amount.expense { color: var(--expense); }
  .tx-amount.cashback { color: var(--cashback); }
  .del-btn {
    background: none; border: none; color: #ccc; cursor: pointer;
    font-size: 18px; padding: 2px 4px; transition: color 0.2s; line-height: 1;
  }
  .del-btn:hover { color: var(--expense); }
  .empty-state { text-align: center; padding: 30px 0; color: var(--subtext); font-size: 13px; }

  @media (max-width: 380px) {
    .bank-card { padding: 16px; }
    .remaining-amount { font-size: 22px; }
    .month-display { font-size: 18px; }
  }
</style>
</head>
<body>

<header>
  <h1>ğŸ¦ ë¹¼ë¡œê°€ë˜ë„¤ ê°€ê³„ë¶€</h1>
</header>

<div class="container">

  <div class="month-selector">
    <button class="month-btn" onclick="changeMonth(-1)">â€¹</button>
    <div class="month-display" id="monthDisplay"></div>
    <button class="month-btn" onclick="changeMonth(1)">â€º</button>
  </div>

  <div class="bank-card">
    <div class="bank-name"><span class="toss-dot"></span>í† ìŠ¤ë±…í¬</div>
    <div class="budget-rows">
      <div class="budget-row">
        <span class="budget-label">ì´ ì…ê¸ˆì•¡</span>
        <span class="budget-value">500,000ì›</span>
      </div>
      <div class="budget-row">
        <span class="budget-label">ì‚¬ìš©ê¸ˆì•¡</span>
        <span class="budget-value" id="totalUsed">0ì›</span>
      </div>
      <div class="budget-row" id="cashbackRow" style="display:none">
        <span class="budget-label">ìºì‹œë°±</span>
        <span class="budget-value green" id="cashbackAmt">+0ì›</span>
      </div>
    </div>
    <div class="remaining-box">
      <span class="remaining-label">ë‚¨ì€ê¸ˆì•¡</span>
      <span class="remaining-amount" id="remaining">500,000ì›</span>
    </div>
    <div class="divider" id="summaryDivider" style="display:none"></div>
    <div class="category-summary" id="categorySummary"></div>
  </div>

  <div class="form-card">
    <div class="form-title" id="formTitle">ì§€ì¶œ ì…ë ¥</div>
    <div class="form-grid">
      <div class="form-group">
        <label>êµ¬ë¶„</label>
        <div class="type-selector">
          <button class="type-btn active expense" onclick="setType('expense')">ì§€ì¶œ</button>
          <button class="type-btn cashback-btn" onclick="setType('cashback')">ìºì‹œë°±</button>
        </div>
      </div>
      <div class="form-group" id="categoryGroup">
        <label>ì¹´í…Œê³ ë¦¬</label>
        <select id="categorySelect">
          <option value="ì‹ë¹„">ì‹ë¹„</option>
          <option value="ì™¸ì‹ë¹„">ì™¸ì‹ë¹„</option>
          <option value="ìƒí™œë¹„">ìƒí™œë¹„</option>
          <option value="êµí†µë¹„">êµí†µë¹„</option>
          <option value="ë¬¸í™”/ì—¬ê°€">ë¬¸í™”/ì—¬ê°€</option>
          <option value="ë¹¼ë¡œê°€ë˜">ë¹¼ë¡œê°€ë˜</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>ë‚ ì§œ</label>
          <input type="date" id="dateInput">
        </div>
        <div class="form-group">
          <label>ê¸ˆì•¡</label>
          <input type="number" id="amountInput" placeholder="0">
        </div>
      </div>
      <div class="form-group">
        <label>ë©”ëª¨</label>
        <input type="text" id="memoInput" placeholder="ë©”ëª¨ (ì„ íƒ)">
      </div>
      <button class="submit-btn" onclick="addTransaction()">ì¶”ê°€í•˜ê¸°</button>
    </div>
  </div>

  <div class="transactions-card">
    <div class="tx-header">
      <span class="tx-title">ì§€ì¶œ ë‚´ì—­</span>
      <button class="clear-btn" onclick="clearAll()">ì „ì²´ ì‚­ì œ</button>
    </div>
    <div class="tx-list" id="txList">
      <div class="empty-state">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>
    </div>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // âœ… ë¹¼ë¡œê°€ë˜ë„¤ ì „ìš© Firebase í”„ë¡œì íŠ¸
  const firebaseConfig = {
    apiKey: "AIzaSyADmhueTat2pklK1MRZI3hKkfwyazfLlxA",
    authDomain: "perogato-b3d77.firebaseapp.com",
    projectId: "perogato-b3d77",
    storageBucket: "perogato-b3d77.firebasestorage.app",
    messagingSenderId: "1055611617152",
    appId: "1:1055611617152:web:f3d69ecd3016209fe8cb65"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const TOTAL_BUDGET = 500000;
  const CATEGORIES = ['ì‹ë¹„', 'ì™¸ì‹ë¹„', 'ìƒí™œë¹„', 'êµí†µë¹„', 'ë¬¸í™”/ì—¬ê°€', 'ë¹¼ë¡œê°€ë˜'];

  let currentMonth = new Date().toISOString().slice(0, 7);
  let cashback = 0;
  let transactions = [];
  let currentType = 'expense';
  let unsubscribe = null;

  document.getElementById('dateInput').value = new Date().toISOString().slice(0, 10);

  window.changeMonth = function(delta) {
    const [y, m] = currentMonth.split('-').map(Number);
    const d = new Date(y, m - 1 + delta, 1);
    currentMonth = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    updateMonthDisplay();
    loadData();
  };

  function updateMonthDisplay() {
    const [y, m] = currentMonth.split('-');
    document.getElementById('monthDisplay').textContent = `${y}ë…„ ${parseInt(m)}ì›”`;
  }

  async function loadData() {
    if (unsubscribe) unsubscribe();
    const snap = await getDoc(doc(db, 'months', currentMonth));
    cashback = snap.exists() ? (snap.data().cashback ?? 0) : 0;

    const q = query(collection(db, 'months', currentMonth, 'transactions'), orderBy('date', 'desc'));
    unsubscribe = onSnapshot(q, (s) => {
      transactions = s.docs.map(d => ({ id: d.id, ...d.data() }));
      renderAll();
    });
  }

  function renderAll() {
    let totalExpense = 0;
    const catMap = {};
    CATEGORIES.forEach(c => catMap[c] = 0);

    transactions.forEach(tx => {
      if (tx.type === 'expense') {
        totalExpense += tx.amount;
        catMap[tx.category] = (catMap[tx.category] ?? 0) + tx.amount;
      }
    });

    const remaining = TOTAL_BUDGET - totalExpense + cashback;
    document.getElementById('totalUsed').textContent = fmt(totalExpense) + 'ì›';
    document.getElementById('remaining').textContent = fmt(remaining) + 'ì›';

    if (cashback > 0) {
      document.getElementById('cashbackRow').style.display = '';
      document.getElementById('cashbackAmt').textContent = '+' + fmt(cashback) + 'ì›';
    } else {
      document.getElementById('cashbackRow').style.display = 'none';
    }

    const activeCats = CATEGORIES.filter(c => catMap[c] > 0);
    const summaryEl = document.getElementById('categorySummary');
    const dividerEl = document.getElementById('summaryDivider');

    if (activeCats.length === 0 && cashback === 0) {
      summaryEl.innerHTML = '';
      dividerEl.style.display = 'none';
    } else {
      dividerEl.style.display = '';
      summaryEl.innerHTML = activeCats.map(c => `
        <div class="cat-row">
          <span class="cat-label">${c}</span>
          <span class="cat-value">-${fmt(catMap[c])}ì›</span>
        </div>
      `).join('') + (cashback > 0 ? `
        <div class="cat-row">
          <span class="cat-label">ìºì‹œë°±</span>
          <span class="cat-value green">+${fmt(cashback)}ì›</span>
        </div>
      ` : '');
    }

    const list = document.getElementById('txList');
    if (transactions.length === 0) {
      list.innerHTML = '<div class="empty-state">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      return;
    }
    list.innerHTML = transactions.map(tx => `
      <div class="tx-item">
        <div class="tx-left">
          <div class="tx-row1">${tx.date} Â· ${tx.type === 'cashback' ? 'ìºì‹œë°±' : tx.category}</div>
          <div class="tx-row2">
            <span>í† ìŠ¤ë±…í¬</span>
            ${tx.memo ? `<span class="tx-memo">Â· ${tx.memo}</span>` : ''}
          </div>
        </div>
        <div class="tx-right">
          <span class="tx-amount ${tx.type}">${tx.type === 'cashback' ? '+' : '-'}${fmt(tx.amount)}ì›</span>
          <button class="del-btn" onclick="deleteTransaction('${tx.id}', '${tx.type}', ${tx.amount})">Ã—</button>
        </div>
      </div>
    `).join('');
  }

  window.setType = function(type) {
    currentType = type;
    document.getElementById('formTitle').textContent = type === 'cashback' ? 'ìºì‹œë°± ì…ë ¥' : 'ì§€ì¶œ ì…ë ¥';
    document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`.type-btn.${type === 'cashback' ? 'cashback-btn' : 'expense'}`).classList.add('active');
    document.getElementById('categoryGroup').style.display = type === 'cashback' ? 'none' : '';
  };

  window.addTransaction = async function() {
    const category = currentType === 'cashback' ? 'ìºì‹œë°±' : document.getElementById('categorySelect').value;
    const date = document.getElementById('dateInput').value;
    const amount = parseInt(document.getElementById('amountInput').value);
    const memo = document.getElementById('memoInput').value.trim();

    if (!date || !amount || amount <= 0) { alert('ë‚ ì§œì™€ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

    if (currentType === 'cashback') {
      const newCashback = (cashback ?? 0) + amount;
      await setDoc(doc(db, 'months', currentMonth), { cashback: newCashback }, { merge: true });
      cashback = newCashback;
    }

    await addDoc(collection(db, 'months', currentMonth, 'transactions'), {
      date, type: currentType, category, memo, amount, createdAt: Date.now()
    });

    document.getElementById('amountInput').value = '';
    document.getElementById('memoInput').value = '';
  };

  window.deleteTransaction = async function(id, type, amount) {
    if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    if (type === 'cashback') {
      const newCashback = Math.max(0, (cashback ?? 0) - amount);
      await setDoc(doc(db, 'months', currentMonth), { cashback: newCashback }, { merge: true });
      cashback = newCashback;
      renderAll();
    }
    await deleteDoc(doc(db, 'months', currentMonth, 'transactions', id));
  };

  window.clearAll = async function() {
    if (!confirm('ì´ë²ˆ ë‹¬ ë‚´ì—­ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    for (const tx of transactions) {
      await deleteDoc(doc(db, 'months', currentMonth, 'transactions', tx.id));
    }
    await setDoc(doc(db, 'months', currentMonth), { cashback: 0 });
    cashback = 0;
    renderAll();
  };

  function fmt(n) { return Number(n || 0).toLocaleString('ko-KR'); }

  updateMonthDisplay();
  loadData();
</script>
</body>
</html>
