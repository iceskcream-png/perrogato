<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>ë¹¼ë¡œê°€ë˜ë„¤ ê°€ê³„ë¶€</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  :root {
    --toss: #3182f6;
    --toss-light: #e8f1ff;
    --cashback: #10b981;
    --expense: #ef4444;
    --bg: #f2f4f8;
    --card: #ffffff;
    --text: #191f28;
    --sub: #8b95a1;
    --border: #eaecf0;
    --radius: 20px;
  }

  html, body {
    font-family: 'Noto Sans KR', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-size: 16px;
    -webkit-font-smoothing: antialiased;
  }

  /* í•˜ë‹¨ íŒ¨ë”© (ë„¤ë¹„ë°” ëŒ€ë¹„) */
  body { padding-bottom: 100px; }

  /* í—¤ë” */
  header {
    background: #fff;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  header h1 { font-size: 17px; font-weight: 700; letter-spacing: -0.3px; }

  .container { max-width: 480px; margin: 0 auto; padding: 0 16px; }

  /* ì›” ì„ íƒ */
  .month-selector {
    display: flex; align-items: center; justify-content: center;
    gap: 24px; padding: 20px 0 16px;
  }
  .month-btn {
    width: 44px; height: 44px;
    background: var(--card); border: none; border-radius: 50%;
    font-size: 20px; cursor: pointer; color: var(--sub);
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 1px 6px rgba(0,0,0,0.08);
    transition: all 0.15s;
  }
  .month-btn:active { transform: scale(0.92); background: var(--toss-light); color: var(--toss); }
  .month-display { font-size: 19px; font-weight: 700; min-width: 130px; text-align: center; }

  /* ì€í–‰ ì¹´ë“œ */
  .bank-card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: 0 2px 16px rgba(0,0,0,0.06);
    margin-bottom: 14px;
  }

  .bank-name {
    font-size: 15px; font-weight: 700;
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 16px; padding-bottom: 14px;
    border-bottom: 1px solid var(--border);
  }
  .toss-icon {
    width: 28px; height: 28px; background: var(--toss);
    border-radius: 8px; display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }
  .toss-icon svg { width: 16px; height: 16px; fill: white; }

  .summary-rows { display: flex; flex-direction: column; gap: 10px; margin-bottom: 14px; }
  .summary-row { display: flex; justify-content: space-between; align-items: center; }
  .s-label { font-size: 14px; color: var(--sub); }
  .s-value { font-size: 14px; font-weight: 500; }
  .s-value.green { color: var(--cashback); font-weight: 600; }

  /* ë‚¨ì€ê¸ˆì•¡ ë°•ìŠ¤ */
  .remaining-box {
    background: var(--toss);
    border-radius: 14px;
    padding: 16px 18px;
    display: flex; justify-content: space-between; align-items: center;
  }
  .r-label { font-size: 13px; color: rgba(255,255,255,0.75); font-weight: 500; }
  .r-amount { font-size: 26px; font-weight: 700; color: white; letter-spacing: -0.5px; }

  .divider { height: 1px; background: var(--border); margin: 14px 0; }

  .cat-summary { display: flex; flex-direction: column; gap: 10px; }
  .cat-row { display: flex; justify-content: space-between; align-items: center; }
  .c-label { font-size: 14px; color: var(--sub); }
  .c-value { font-size: 14px; font-weight: 500; }
  .c-value.green { color: var(--cashback); font-weight: 600; }

  /* ì…ë ¥ í¼ */
  .form-card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: 0 2px 16px rgba(0,0,0,0.06);
    margin-bottom: 14px;
  }
  .form-title { font-size: 16px; font-weight: 700; margin-bottom: 18px; }

  .form-group { display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px; }
  .form-group label { font-size: 12px; color: var(--sub); font-weight: 500; letter-spacing: 0.2px; }

  /* êµ¬ë¶„ ë²„íŠ¼ */
  .type-row { display: flex; gap: 10px; }
  .type-btn {
    flex: 1; padding: 13px 10px;
    border: 1.5px solid var(--border); border-radius: 12px;
    background: var(--bg); font-size: 14px; font-weight: 600;
    cursor: pointer; transition: all 0.15s;
    font-family: 'Noto Sans KR', sans-serif; color: var(--sub);
  }
  .type-btn:active { transform: scale(0.97); }
  .type-btn.active.expense { background: #fff1f1; border-color: var(--expense); color: var(--expense); }
  .type-btn.active.cashback-btn { background: #f0fdf4; border-color: var(--cashback); color: var(--cashback); }

  /* ì…€ë ‰íŠ¸ & ì¸í’‹ */
  select, input[type="date"], input[type="number"], input[type="text"] {
    width: 100%;
    padding: 14px 14px;
    border: 1.5px solid var(--border);
    border-radius: 12px;
    font-size: 15px;
    font-family: 'Noto Sans KR', sans-serif;
    color: var(--text);
    background: var(--bg);
    outline: none;
    transition: border-color 0.2s, background 0.2s;
    -webkit-appearance: none;
    appearance: none;
  }
  select:focus, input:focus {
    border-color: var(--toss);
    background: white;
  }

  /* ì…€ë ‰íŠ¸ í™”ì‚´í‘œ ì»¤ìŠ¤í…€ */
  .select-wrap { position: relative; }
  .select-wrap::after {
    content: 'â–¾';
    position: absolute; right: 14px; top: 50%; transform: translateY(-50%);
    color: var(--sub); pointer-events: none; font-size: 13px;
  }
  .select-wrap select { padding-right: 36px; }

  .two-col { display: flex; gap: 10px; }
  .two-col .form-group { flex: 1; margin-bottom: 0; }

  /* ì¶”ê°€ ë²„íŠ¼ */
  .submit-btn {
    width: 100%; padding: 16px;
    border: none; border-radius: 14px;
    background: var(--toss); color: white;
    font-size: 16px; font-weight: 700;
    cursor: pointer; margin-top: 4px;
    font-family: 'Noto Sans KR', sans-serif;
    transition: all 0.15s;
    letter-spacing: -0.3px;
  }
  .submit-btn:active { transform: scale(0.97); opacity: 0.9; }

  /* ë‚´ì—­ */
  .tx-card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: 0 2px 16px rgba(0,0,0,0.06);
  }
  .tx-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .tx-title { font-size: 16px; font-weight: 700; }
  .clear-btn {
    font-size: 13px; color: var(--expense);
    background: #fff1f1; border: none; border-radius: 8px;
    padding: 6px 12px; cursor: pointer;
    font-family: 'Noto Sans KR', sans-serif; font-weight: 500;
    transition: opacity 0.15s;
  }
  .clear-btn:active { opacity: 0.7; }

  .tx-list { display: flex; flex-direction: column; }
  .tx-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 14px 0; border-bottom: 1px solid var(--border);
  }
  .tx-item:last-child { border-bottom: none; }
  .tx-left { flex: 1; min-width: 0; }
  .tx-top { font-size: 12px; color: var(--sub); margin-bottom: 4px; }
  .tx-bottom { font-size: 14px; color: var(--text); display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
  .tx-memo { font-size: 13px; color: #b0b8c1; }
  .tx-right { display: flex; align-items: center; gap: 10px; flex-shrink: 0; margin-left: 10px; }
  .tx-amount { font-size: 15px; font-weight: 700; }
  .tx-amount.expense { color: var(--expense); }
  .tx-amount.cashback { color: var(--cashback); }
  .del-btn {
    width: 30px; height: 30px;
    background: var(--bg); border: none; border-radius: 50%;
    color: var(--sub); cursor: pointer; font-size: 16px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s; flex-shrink: 0;
  }
  .del-btn:active { background: #fff1f1; color: var(--expense); }

  .empty-state {
    text-align: center; padding: 36px 0;
    color: var(--sub); font-size: 14px; line-height: 1.8;
  }
  .empty-state .emoji { font-size: 32px; display: block; margin-bottom: 8px; }
</style>
</head>
<body>

<header>
  <h1>ğŸ¦ ë¹¼ë¡œê°€ë˜ë„¤ ê°€ê³„ë¶€</h1>
</header>

<div class="container">

  <!-- ì›” ì„ íƒ -->
  <div class="month-selector">
    <button class="month-btn" onclick="changeMonth(-1)">â€¹</button>
    <div class="month-display" id="monthDisplay"></div>
    <button class="month-btn" onclick="changeMonth(1)">â€º</button>
  </div>

  <!-- í† ìŠ¤ë±…í¬ ì¹´ë“œ -->
  <div class="bank-card">
    <div class="bank-name">
      <div class="toss-icon">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/></svg>
      </div>
      í† ìŠ¤ë±…í¬
    </div>

    <div class="summary-rows">
      <div class="summary-row">
        <span class="s-label">ì´ ì…ê¸ˆì•¡</span>
        <span class="s-value">500,000ì›</span>
      </div>
      <div class="summary-row">
        <span class="s-label">ì‚¬ìš©ê¸ˆì•¡</span>
        <span class="s-value" id="totalUsed">0ì›</span>
      </div>
      <div class="summary-row" id="cashbackRow" style="display:none">
        <span class="s-label">ìºì‹œë°±</span>
        <span class="s-value green" id="cashbackAmt">+0ì›</span>
      </div>
    </div>

    <div class="remaining-box">
      <span class="r-label">ë‚¨ì€ê¸ˆì•¡</span>
      <span class="r-amount" id="remaining">500,000ì›</span>
    </div>

    <div class="divider" id="summaryDivider" style="display:none"></div>
    <div class="cat-summary" id="catSummary"></div>
  </div>

  <!-- ì…ë ¥ í¼ -->
  <div class="form-card">
    <div class="form-title" id="formTitle">ì§€ì¶œ ì…ë ¥</div>

    <div class="form-group">
      <label>êµ¬ë¶„</label>
      <div class="type-row">
        <button class="type-btn active expense" onclick="setType('expense')">ğŸ’¸ ì§€ì¶œ</button>
        <button class="type-btn cashback-btn" onclick="setType('cashback')">ğŸ’° ìºì‹œë°±</button>
      </div>
    </div>

    <div class="form-group" id="categoryGroup">
      <label>ì¹´í…Œê³ ë¦¬</label>
      <div class="select-wrap">
        <select id="categorySelect">
          <option value="ì‹ë¹„">ğŸš ì‹ë¹„</option>
          <option value="ì™¸ì‹ë¹„">ğŸ½ï¸ ì™¸ì‹ë¹„</option>
          <option value="ìƒí™œë¹„">ğŸ  ìƒí™œë¹„</option>
          <option value="êµí†µë¹„">ğŸšŒ êµí†µë¹„</option>
          <option value="ë¬¸í™”/ì—¬ê°€">ğŸ¬ ë¬¸í™”/ì—¬ê°€</option>
          <option value="ë¹¼ë¡œê°€ë˜">ğŸ¦ ë¹¼ë¡œê°€ë˜</option>
        </select>
      </div>
    </div>

    <div class="two-col">
      <div class="form-group">
        <label>ë‚ ì§œ</label>
        <input type="date" id="dateInput">
      </div>
      <div class="form-group">
        <label>ê¸ˆì•¡ (ì›)</label>
        <input type="number" id="amountInput" placeholder="0" inputmode="numeric">
      </div>
    </div>

    <div class="form-group" style="margin-top:12px">
      <label>ë©”ëª¨ (ì„ íƒ)</label>
      <input type="text" id="memoInput" placeholder="ì˜ˆ) ë§ˆíŠ¸, ì ì‹¬ì‹ì‚¬...">
    </div>

    <button class="submit-btn" onclick="addTransaction()">ì¶”ê°€í•˜ê¸°</button>
  </div>

  <!-- ì§€ì¶œ ë‚´ì—­ -->
  <div class="tx-card">
    <div class="tx-header">
      <span class="tx-title">ì§€ì¶œ ë‚´ì—­</span>
      <button class="clear-btn" onclick="clearAll()">ì „ì²´ ì‚­ì œ</button>
    </div>
    <div class="tx-list" id="txList">
      <div class="empty-state">
        <span class="emoji">ğŸ“</span>
        ì•„ì§ ë‚´ì—­ì´ ì—†ì–´ìš”
      </div>
    </div>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const app = initializeApp({
    apiKey: "AIzaSyADmhueTat2pklK1MRZI3hKkfwyazfLlxA",
    authDomain: "perogato-b3d77.firebaseapp.com",
    projectId: "perogato-b3d77",
    storageBucket: "perogato-b3d77.firebasestorage.app",
    messagingSenderId: "1055611617152",
    appId: "1:1055611617152:web:f3d69ecd3016209fe8cb65"
  });
  const db = getFirestore(app);

  const TOTAL_BUDGET = 500000;
  const CATEGORIES = ['ì‹ë¹„', 'ì™¸ì‹ë¹„', 'ìƒí™œë¹„', 'êµí†µë¹„', 'ë¬¸í™”/ì—¬ê°€', 'ë¹¼ë¡œê°€ë˜'];
  const CAT_EMOJI = { 'ì‹ë¹„':'ğŸš', 'ì™¸ì‹ë¹„':'ğŸ½ï¸', 'ìƒí™œë¹„':'ğŸ ', 'êµí†µë¹„':'ğŸšŒ', 'ë¬¸í™”/ì—¬ê°€':'ğŸ¬', 'ë¹¼ë¡œê°€ë˜':'ğŸ¦' };

  let currentMonth = new Date().toISOString().slice(0, 7);
  let cashback = 0;
  let transactions = [];
  let currentType = 'expense';
  let unsubscribe = null;

  document.getElementById('dateInput').value = new Date().toISOString().slice(0, 10);

  window.changeMonth = function(delta) {
    const [y, m] = currentMonth.split('-').map(Number);
    const d = new Date(y, m - 1 + delta, 1);
    currentMonth = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    updateMonthDisplay();
    loadData();
  };

  function updateMonthDisplay() {
    const [y, m] = currentMonth.split('-');
    document.getElementById('monthDisplay').textContent = `${y}ë…„ ${parseInt(m)}ì›”`;
  }

  async function loadData() {
    if (unsubscribe) unsubscribe();
    const snap = await getDoc(doc(db, 'months', currentMonth));
    cashback = snap.exists() ? (snap.data().cashback ?? 0) : 0;
    const q = query(collection(db, 'months', currentMonth, 'transactions'), orderBy('date', 'desc'));
    unsubscribe = onSnapshot(q, (s) => {
      transactions = s.docs.map(d => ({ id: d.id, ...d.data() }));
      renderAll();
    });
  }

  function renderAll() {
    let totalExpense = 0;
    const catMap = {};
    CATEGORIES.forEach(c => catMap[c] = 0);
    transactions.forEach(tx => {
      if (tx.type === 'expense') {
        totalExpense += tx.amount;
        catMap[tx.category] = (catMap[tx.category] ?? 0) + tx.amount;
      }
    });

    const remaining = TOTAL_BUDGET - totalExpense + cashback;
    document.getElementById('totalUsed').textContent = fmt(totalExpense) + 'ì›';
    document.getElementById('remaining').textContent = fmt(remaining) + 'ì›';

    if (cashback > 0) {
      document.getElementById('cashbackRow').style.display = '';
      document.getElementById('cashbackAmt').textContent = '+' + fmt(cashback) + 'ì›';
    } else {
      document.getElementById('cashbackRow').style.display = 'none';
    }

    const activeCats = CATEGORIES.filter(c => catMap[c] > 0);
    const summaryEl = document.getElementById('catSummary');
    const dividerEl = document.getElementById('summaryDivider');

    if (activeCats.length === 0 && cashback === 0) {
      summaryEl.innerHTML = '';
      dividerEl.style.display = 'none';
    } else {
      dividerEl.style.display = '';
      summaryEl.innerHTML = activeCats.map(c => `
        <div class="cat-row">
          <span class="c-label">${CAT_EMOJI[c] || ''} ${c}</span>
          <span class="c-value">-${fmt(catMap[c])}ì›</span>
        </div>
      `).join('') + (cashback > 0 ? `
        <div class="cat-row">
          <span class="c-label">ğŸ’° ìºì‹œë°±</span>
          <span class="c-value green">+${fmt(cashback)}ì›</span>
        </div>
      ` : '');
    }

    const list = document.getElementById('txList');
    if (transactions.length === 0) {
      list.innerHTML = '<div class="empty-state"><span class="emoji">ğŸ“</span>ì•„ì§ ë‚´ì—­ì´ ì—†ì–´ìš”</div>';
      return;
    }
    list.innerHTML = transactions.map(tx => {
      const emoji = tx.type === 'cashback' ? 'ğŸ’°' : (CAT_EMOJI[tx.category] || '');
      return `
        <div class="tx-item">
          <div class="tx-left">
            <div class="tx-top">${tx.date} Â· ${tx.type === 'cashback' ? 'ìºì‹œë°±' : tx.category}</div>
            <div class="tx-bottom">
              <span>${emoji} í† ìŠ¤ë±…í¬</span>
              ${tx.memo ? `<span class="tx-memo">Â· ${tx.memo}</span>` : ''}
            </div>
          </div>
          <div class="tx-right">
            <span class="tx-amount ${tx.type}">${tx.type === 'cashback' ? '+' : '-'}${fmt(tx.amount)}ì›</span>
            <button class="del-btn" onclick="deleteTransaction('${tx.id}', '${tx.type}', ${tx.amount})">Ã—</button>
          </div>
        </div>
      `;
    }).join('');
  }

  window.setType = function(type) {
    currentType = type;
    document.getElementById('formTitle').textContent = type === 'cashback' ? 'ğŸ’° ìºì‹œë°± ì…ë ¥' : 'ğŸ’¸ ì§€ì¶œ ì…ë ¥';
    document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`.type-btn.${type === 'cashback' ? 'cashback-btn' : 'expense'}`).classList.add('active');
    document.getElementById('categoryGroup').style.display = type === 'cashback' ? 'none' : '';
  };

  window.addTransaction = async function() {
    const category = currentType === 'cashback' ? 'ìºì‹œë°±' : document.getElementById('categorySelect').value;
    const date = document.getElementById('dateInput').value;
    const amount = parseInt(document.getElementById('amountInput').value);
    const memo = document.getElementById('memoInput').value.trim();

    if (!date || !amount || amount <= 0) { alert('ë‚ ì§œì™€ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

    if (currentType === 'cashback') {
      const newCashback = (cashback ?? 0) + amount;
      await setDoc(doc(db, 'months', currentMonth), { cashback: newCashback }, { merge: true });
      cashback = newCashback;
    }

    await addDoc(collection(db, 'months', currentMonth, 'transactions'), {
      date, type: currentType, category, memo, amount, createdAt: Date.now()
    });

    document.getElementById('amountInput').value = '';
    document.getElementById('memoInput').value = '';
  };

  window.deleteTransaction = async function(id, type, amount) {
    if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    if (type === 'cashback') {
      const newCashback = Math.max(0, (cashback ?? 0) - amount);
      await setDoc(doc(db, 'months', currentMonth), { cashback: newCashback }, { merge: true });
      cashback = newCashback;
      renderAll();
    }
    await deleteDoc(doc(db, 'months', currentMonth, 'transactions', id));
  };

  window.clearAll = async function() {
    if (!confirm('ì´ë²ˆ ë‹¬ ë‚´ì—­ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    for (const tx of transactions) {
      await deleteDoc(doc(db, 'months', currentMonth, 'transactions', tx.id));
    }
    await setDoc(doc(db, 'months', currentMonth), { cashback: 0 });
    cashback = 0;
    renderAll();
  };

  function fmt(n) { return Number(n || 0).toLocaleString('ko-KR'); }

  updateMonthDisplay();
  loadData();
</script>
</body>
</html>
